//Programa que enlista productos de un supermercado con sus precios, tipo y código identificador
#include <iostream>	//Librería para datos de entrada y salida
#include <fstream>	//Librería para poder leer en ficheros o escribir en estos
#include <conio.h>	//Librería usada para dar presentación al texto en la consola

using namespace std; 	// Para abreviar el uso de comandos de entrada y salida

//estructura llamada Nodo para guardar los productos de nuestra lista
struct Node{
	int 	id;            //id del producto
	char 	producto[30];  //nombre del producto
	double 	precio;        //precio del producto
	char	categoria[20]; //categoria del producto
	Node	*ant;          //apuntador hacia el Nodo del producto anterior
	Node	*sig;          //apuntador hacia el Nodo del producto siguiente
};

class LinkedList{
	private:
		Node * first = 0;
		Node * last = 0;
		char * file;
		int seed = 100;
		short incr = 10;
		
	public:
		LinkedList(char *file){
			this->file = file;
			ifstream archivito;
			Node *aux = NULL;
			archivito.open(file, ios::binary);
			if(archivito.is_open()){
				//leer del archivo cada cierto número de bytes
				aux = new Node;
				archivito.read((char*)aux, sizeof(Node));
				while(!archivito.eof()){
					//y agregarlos a la lista ligada
					AddNode(aux, 1);
					aux = new Node;
					archivito.read((char*)aux, sizeof(Node));
				}
				archivito.close();
			}
		}
		~LinkedList(){
			ofstream archivito;
			archivito.open(file, ios::binary);
			Node *aux = 0, *aux2 = 0;
			if(archivito.is_open()){
				aux = first;
				while(aux!=0){
					//escribir en el archivo cada nodo aux
					archivito.write((char*)aux, sizeof(Node));
					aux2 = aux;
					aux = aux->sig;
					delete aux2;
				}
				archivito.close();
			} 
		}
		Node *getFirst(){
			return first;
		}
		Node *getLast(){
			return last;
		}
		
		void AddNode(Node *nuevo, short source)
		//Source = 1, viene de archivo,
		//Source = 0, se captura de pantalla
		{
			nuevo->ant = 0;
			nuevo->sig = 0;
			if(source == 0){
				nuevo->id = seed + incr;
				seed += incr;
			}
			else{
				seed = nuevo->id;
			}
			
			if(first == 0){
				nuevo->id = seed;
				first = last = nuevo;
			}
			else{
				last->sig = nuevo;
				nuevo->ant = last;
				last = nuevo;
			}
		}
		
		void DeleteNode(Node *temp){
			if(first == temp){
				first = temp->sig;
				if(temp->sig != 0)
					temp->sig->ant = 0;
			}
			else{
				temp->ant->sig = temp->sig;
				if(temp->sig != 0)
					temp->sig->ant = temp->ant;
			}
			delete temp;
		}
		
		//Busqueda Secuencial por id
		Node *SearchNode(int ID){
			Node *aux = 0;
			bool siloencontre = false;
			aux = first;
			while(aux != 0){
				if(ID == aux->id){
					siloencontre = true;
					break;
				}
				aux = aux->sig;
			}
			if(siloencontre)
				return aux;
			else
				return 0;
		}
};

//se ingresan las cabeceras de dos funciones que se especifican mas adelante para capturar y mostrar los productos
void CapturaDatos(Node *temp);
void MuestraDatos(Node *temp);

//funcion principal del programa
int main(){
	Node *aux = 0, *nuevo = 0;         //se igualan a cero los nodos auxiliar y nuevo
	int opc = 0, opc2 = 0;             //se declaran dos enteros para saber las opciones que el usuario elige a traves del menú
	Node Temp;                         //se declara un nodo temporal
	char archi[] = "productos.dat";    //se ingresa el nombre del archivo binario en el cual se trabajara 
	
	LinkedList Lista_Productos(archi); //se declara una nueva lista llamada Lista_productos a traves del constructor y utilizando el archivo nombrado anteriormente
	
	do{
			//se limpia la consola y se imprime el menú de opciones a realizar con la lista de productos
		system("cls");
		printf("<<GESTION DE PRODUCTOS>> \n");
		printf("1. Agregar Producto\n");
		printf("2. Buscar por Id (Secuencial)\n");
		printf("3. Mostrar lista de productos\n");
		printf("4. Buscar por Producto (Binaria)\n");
		printf("5. Ordenar por Producto (_Sort)\n");
		printf("6. Ordenar por Precio (_Sort)\n");
		printf("7. Salir\n");
		cin >> opc;    //se registra la seleccion del usuario y luego se utiliza un switch para cada caso del menú
		switch(opc){
			case 1:
					//en el primer caso se agrega un producto
				system("cls");                         //se limpia la consola
				printf("Agregar PRODUCTO\n");          //se imprime lo que se hara que es agregar un producto
				nuevo = new Node;                      //creamos un nuevo nodo
				nuevo->id = 0;                         //declaramos el id de este nuevo producto en 0
				CapturaDatos(nuevo);                   //utilizamos la funcion capturadatos para guardar el producto en el nodo nuevo
				Lista_Productos.AddNode(nuevo, 0);     //agregamos este nodo a la lista y especificamos que fue ingresado por el usuario
				printf("\nDatos agregados");           //confirmamos que los datos han sido guardados correctamente
				_getch();                              //esperamos a que el usuario continue y terminamos este caso
				break;
			case 2:
					//en el segundo caso buscamos productos por su ID y luego preguntamos al usuario que desea hacer con el
				system("cls");                                //limpiamos la consola
				printf("Buscar Producto por ID\n");           //volvemos a mencionar al usuario la opcion que selecciono
				printf("Id: "); cin >> Temp.id;               //guardamos el Id del porducto en nuestro nodo temporal
				aux = Lista_Productos.SearchNode(Temp.id);    //utilizando la funcion searchNode buscamos el id del producto 
				if(aux != 0){                                 //comparamos para ver si el dato se encontro       
					printf("Datos encontrados:\n");       //confirmamos al usuario que se encontro el dato
					MuestraDatos(aux);                    //lo mostramos al usuario
						
						//ahora le preguntamos al usuario si desea simplemente volver, modificar o eliminar el dato encontrado
					printf("Desea:\n 0) Regresar 1) Modificar 2) Eliminar: "); cin >> opc2; 
					switch(opc2){                 
						case 1: //en el caso que se quiera modificar se realiza lo mismo que en el caso que se requiera agregar productos
						{
							CapturaDatos(aux);
							printf("El id-producto %d fue modificado\n", aux->id);
							break;
						}
						case 2: //para eliminar un producto simplemente utilisamos la funcion deletenode
						{
							printf("El producto %s fue eliminado\n", aux->producto);
							Lista_Productos.DeleteNode(aux);
							_getch();
							break;
						}
						default: //en cualquier otro caso simplemente regresamos y damos las gracias
							printf("Gracias por participar");
							break;
					}
				}
				else
					printf("Dato NO Encontrado");
				_getch();
				break;
			case 3:
				system("cls");
				printf("ID\tPRODUCTO\t\tPRECIO\t\tCATEGORIA\n");
				aux = Lista_Productos.getFirst();
				while(aux != 0){
					printf("%d\t%s\t\t%10.2lf\t\t%s\n",aux->id, aux->producto, aux->precio, aux->categoria);
					aux = aux->sig;
				}
				_getch();
				break;
			case 4:
				break;
		}
	
	}while(opc<7);
	
	printf("\a");
	_getch();
}

void CapturaDatos(Node *temp){
	cout << "Producto: "; 	cin >> temp->producto;
	cout << "Precio: ";		cin >> temp->precio;
	cout << "Categoria: ";	cin >> temp->categoria;
}

void MuestraDatos(Node *temp){
	//printf("Id:\t%d\n",			temp->id);
	printf("Producto:\t%s\n",	temp->producto);
	printf("Precio:\t%10.2lf\n",	temp->precio);
	printf("Categoria:\t%s\n", temp->categoria);
}
